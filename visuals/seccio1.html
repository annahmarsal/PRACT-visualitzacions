import os
import pandas as pd
import plotly.graph_objects as go

# --- Fitxers dins /data
ELEC_CSV = os.path.join("data", "share-of-the-population-with-access-to-electricity.csv")
COOK_CSV = os.path.join("data", "access-to-clean-fuels-and-technologies-for-cooking.csv")

# --- Columnes
COL_ENTITY, COL_YEAR = "Entity", "Year"
ELEC_COL = "Access to electricity (% of population)"

# --- Carrega electricitat (World)
e = pd.read_csv(ELEC_CSV)
e = e[e[COL_ENTITY] == "World"][[COL_YEAR, ELEC_COL]].dropna()
e[COL_YEAR] = e[COL_YEAR].astype(int)
e[ELEC_COL] = pd.to_numeric(e[ELEC_COL], errors="coerce")

# --- Carrega cuina neta (World) i detecta columna de valor
c = pd.read_csv(COOK_CSV)
cook_val_cols = [x for x in c.columns if x not in {COL_ENTITY, "Code", COL_YEAR}]
if len(cook_val_cols) != 1:
    raise ValueError(f"No puc identificar la columna de valor de cuina neta: {cook_val_cols}")
COOK_COL = cook_val_cols[0]

c = c[c[COL_ENTITY] == "World"][[COL_YEAR, COOK_COL]].dropna()
c[COL_YEAR] = c[COL_YEAR].astype(int)
c[COOK_COL] = pd.to_numeric(c[COOK_COL], errors="coerce")

# --- Unir i ordenar
w = pd.merge(e, c, on=COL_YEAR, how="outer").sort_values(COL_YEAR)
w = w.rename(columns={COL_YEAR: "Any", ELEC_COL: "Electricitat", COOK_COL: "Cuina neta"})
w = w.dropna(subset=["Any"])
w["Any"] = w["Any"].astype(int)

years = sorted(w["Any"].unique())
y0, y1 = min(years), 2030

# --- Frames: cada any mostra la sèrie fins aquell any
frames = [
    go.Frame(
        name=str(y),
        data=[
            go.Scatter(x=w.loc[w["Any"] <= y, "Any"], y=w.loc[w["Any"] <= y, "Electricitat"]),
            go.Scatter(x=w.loc[w["Any"] <= y, "Any"], y=w.loc[w["Any"] <= y, "Cuina neta"]),
        ],
    )
    for y in years
]

# --- Figura base (dues traces buides)
fig = go.Figure(
    data=[
        go.Scatter(mode="lines", name="Electricitat"),
        go.Scatter(mode="lines", name="Combustibles nets per cuinar"),
    ],
    frames=frames,
)

# --- Layout + controls
fig.update_layout(
    title=dict(
        text=(
            "ODS 7: Accés universal a una energia neta, fiable i sostenible<br>"
            "<span style='font-size:14px; font-weight:normal;'>"
            "Quina és la situació mundial en l'accés a l’electricitat i els combustibles nets per cuinar a 7 anys de l’horitzó 2030?"
            "</span>"
        ),
        x=0.5,
        xanchor="center"),
    xaxis=dict(title="Any", range=[y0, y1]),
    yaxis=dict(title="Percentatge de població (%)", range=[0, 100]),
    hovermode="x unified",
    template="plotly_white",
    margin=dict(l=60, r=120, t=110, b=60),
        legend=dict(
        orientation="h",
        yanchor="top",
        y=-0.2,
        xanchor="center",
        x=0.5
    ),
    updatemenus=[dict(
        type="buttons",
        direction="left",
        x=0.0, y=1.15,
        buttons=[
            dict(label="Reproduir", method="animate",
                 args=[None, {"frame": {"duration": 80, "redraw": True},
                              "transition": {"duration": 0},
                              "fromcurrent": True}]),
            dict(label="Pausa", method="animate",
                 args=[[None], {"frame": {"duration": 0, "redraw": False},
                                "mode": "immediate"}])
        ]
    )],
    sliders=[dict(
        x=0.05, y=0, len=0.9,
        currentvalue={"prefix": "Any: "},
        steps=[
            dict(method="animate",
                 args=[[str(y)], {"mode": "immediate",
                                  "frame": {"duration": 80, "redraw": True},
                                  "transition": {"duration": 0}}],
                 label=str(y))
            for y in years
        ]
    )]
)

# --- Referència objectiu ODS 7
fig.add_hline(
    y=100,
    line_dash="dash",
    annotation_text="Objectiu ODS 7 (100%) el 2030",
    annotation_position="bottom left"
)

fig.write_html("seccio1_ods7_animada.html", include_plotlyjs="cdn")
print("Creat: seccio1_ods7_animada.html")
